---
title: "xgboost Data-Rate Prediction"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(tidyverse)
library(ggplot2)

library(mlr3)
library(mlr3learners)
library(mlr3pipelines)
library(mlr3tuning)
library(paradox)
```

```{r}
future::plan("multiprocess")
```

# Upload-Rate Prediction

## Reading the Data

```{r}
data_dir = "../datasets/"

dataset_ul = read_csv(
  str_c(data_dir, "dataset_ul.csv"), 
  col_types = cols(
    drive_id = col_integer(),
    scenario = col_factor(), 
    provider = col_factor(), 
    ci = col_factor(), 
    enodeb = col_factor()
  )
) %>% select(
  drive_id,
  timestamp,
  scenario,
  provider,
  velocity_mps,
  acceleration_mpss,
  rsrp_dbm,
  rsrq_db,
  rssnr_db,
  cqi,
  ta,
  enodeb,
  f_mhz,
  payload_mb,
  throughput_mbits
) %>% drop_na() %>% rowid_to_column(var="row_id_original")
```

```{r}
dataset_ul_o2 = filter(dataset_ul, provider=="o2")
glimpse(dataset_ul_o2)

dataset_ul_tmobile = filter(dataset_ul, provider=="tmobile")
glimpse(dataset_ul_tmobile)

dataset_ul_vodafone = filter(dataset_ul, provider=="vodafone")
glimpse(dataset_ul_vodafone)
```

## Create the Prediction Tasks for Each Provider

```{r}
make_task = function(dataset, task_id) {
  task = TaskRegr$new(
    id = task_id,
    backend = dataset %>% select(-drive_id, -timestamp, -provider, -scenario),
    target = "throughput_mbits"
  )
  
  task$col_roles$name = "row_id_original"
  task$col_roles$feature = setdiff(task$col_roles$feature, "row_id_original")
  
  return(task)
}

task_ul_o2 = make_task(dataset_ul_o2, "task_ul_o2")
task_ul_o2

task_ul_tmobile = make_task(dataset_ul_tmobile, "task_ul_tmobile")
task_ul_tmobile

task_ul_vodafone = make_task(dataset_ul_vodafone, "task_ul_vodafone")
task_ul_vodafone
```

## Create Data Splitting Strategies for Testing and Validation

The outer resampling is used for the train/validation split.
```{r}
get_row_ids_by_drive_ids = function(task, drive_ids) {
  result = (tibble(task$row_names) %>% 
    inner_join(dataset_ul, by=c("row_name"="row_id_original")) %>%
    filter(drive_id %in% drive_ids))$row_id
  return(result)
}

make_outer_resampling = function(task, drive_ids_train, drive_ids_test) {
  row_ids_train = get_row_ids_by_drive_ids(task, drive_ids_train)
  row_ids_test = get_row_ids_by_drive_ids(task, drive_ids_test)
  
  result = rsmp("custom")
  result$instantiate(task, train_sets=list(row_ids_train), test_sets=list(row_ids_test))
  
  return(result)
}
```

The inner resampling is used for the parameter tuning on the training set.
```{r}
make_inner_resampling = function(task, last_drive_id) {
  train_sets = list()
  test_sets = list()
  
  for (cur_last_drive_id_train in 2:(last_drive_id-1)) {
    drive_ids_train = 1:cur_last_drive_id_train
    drive_ids_test = cur_last_drive_id_train + 1
    
    row_ids_train = get_row_ids_by_drive_ids(task, drive_ids_train)
    row_ids_test = get_row_ids_by_drive_ids(task, drive_ids_test)
    
    train_sets[[length(train_sets)+1]] = row_ids_train
    test_sets[[length(test_sets)+1]] = row_ids_test
  }
  
  result = rsmp("custom")
  result$instantiate(task, train_sets=train_sets, test_sets=test_sets)
  
  return(result)
}
```

## Create the Prediction Pipeline for Each Provider

```{r}
make_learner = function(nrounds=100, eta=NULL, gamma=NULL, lambda=NULL) {
  factor_encoding = po(
    "encode",
    method = "one-hot",
    affect_columns = selector_type("factor")
  )
  xgboost = lrn("regr.xgboost")
  
  if (!is.null(nrounds)) {
    xgboost$param_set$values = mlr3misc::insert_named(
      xgboost$param_set$values,
      list(nrounds=nrounds)
    )
  }
  if (!is.null(eta)) {
    xgboost$param_set$values = mlr3misc::insert_named(
      xgboost$param_set$values,
      list(eta=eta)
    )
  }
  if (!is.null(gamma)) {
    xgboost$param_set$values = mlr3misc::insert_named(
      xgboost$param_set$values,
      list(gamma=gamma)
    )
  }
  if (!is.null(lambda)) {
    xgboost$param_set$values = mlr3misc::insert_named(
      xgboost$param_set$values,
      list(lambda=lambda)
    )
  }
  
  pipe = factor_encoding %>>% PipeOpLearner$new(xgboost)
  learner = GraphLearner$new(pipe)
  return(learner)
}
```

Here we can see the prediction pipeline:
```{r}
make_learner()$graph$plot()
```

## Parameter Tuning

```{r}
parameter_space = ParamSet$new(list(
  ParamInt$new("regr.xgboost.nrounds", lower=100, upper=1000),
  ParamDbl$new("regr.xgboost.eta", lower=0.01, upper=1),
  ParamDbl$new("regr.xgboost.gamma", lower=0, upper=10),
  ParamDbl$new("regr.xgboost.lambda", lower=0, upper=10)
))
```

```{r}
get_tuning_result = function(task, grid_resolution, n_evals) {
  tuning_instance = TuningInstanceSingleCrit$new(
    task = task,
    learner = make_learner(),
    resampling = make_inner_resampling(task, last_drive_id=7),
    measure = msr("regr.mae"),
    terminator = trm("evals", n_evals=n_evals),
    search_space = parameter_space,
    store_benchmark_result = TRUE,
    check_values = TRUE
  )
  
  tuner = tnr("grid_search", resolution = grid_resolution)
  tuner$optimize(tuning_instance)
  
  return(tuning_instance)
}
```

```{r, results = "hide"}
tuning_result_o2 = get_tuning_result(task_ul_o2, grid_resolution = 20, n_evals = 10)

tuning_result_tmobile = get_tuning_result(task_ul_tmobile, grid_resolution = 20, n_evals = 10)

tuning_result_vodafone = get_tuning_result(task_ul_vodafone, grid_resolution = 20, n_evals = 10)
```

```{r}
tuning_result_o2$result
tuning_result_tmobile$result
tuning_result_vodafone$result
```

## Create Learners with Tuned Hyperparameters

```{r}
learner_ul_o2 = make_learner(
  nrounds = tuning_result_o2$result$regr.xgboost.nrounds,
  eta = tuning_result_o2$result$regr.xgboost.eta,
  gamma = tuning_result_o2$result$regr.xgboost.gamma,
  lambda = tuning_result_o2$result$regr.xgboost.lambda
)

learner_ul_tmobile = make_learner(
  nrounds = tuning_result_tmobile$result$regr.xgboost.nrounds,
  eta = tuning_result_tmobile$result$regr.xgboost.eta,
  gamma = tuning_result_tmobile$result$regr.xgboost.gamma,
  lambda = tuning_result_tmobile$result$regr.xgboost.lambda
)

learner_ul_vodafone = make_learner(
  nrounds = tuning_result_vodafone$result$regr.xgboost.nrounds,
  eta = tuning_result_vodafone$result$regr.xgboost.eta,
  gamma = tuning_result_vodafone$result$regr.xgboost.gamma,
  lambda = tuning_result_vodafone$result$regr.xgboost.lambda
)
```

## Validation Results

```{r, results = "hide"}
resampling_result_ul_o2 = resample(
  task = task_ul_o2,
  learner = learner_ul_o2,
  resampling = make_outer_resampling(task_ul_o2, drive_ids_train=1:7, drive_ids_test=8:10),
  store_models = TRUE
)

resampling_result_ul_tmobile = resample(
  task = task_ul_tmobile,
  learner = learner_ul_tmobile,
  resampling = make_outer_resampling(task_ul_tmobile, drive_ids_train=1:7, drive_ids_test=8:10),
  store_models = TRUE
)

resampling_result_ul_vodafone = resample(
  task = task_ul_vodafone,
  learner = learner_ul_vodafone,
  resampling = make_outer_resampling(task_ul_vodafone, drive_ids_train=1:7, drive_ids_test=8:10),
  store_models = TRUE
)
```

```{r}
predictions_ul_o2 = as.data.table(resampling_result_ul_o2$prediction())
glimpse(tibble(predictions_ul_o2))
predictions_ul_tmobile = as.data.table(resampling_result_ul_tmobile$prediction())
predictions_ul_vodafone = as.data.table(resampling_result_ul_vodafone$prediction())
```

```{r}
validation_results_ul = bind_rows(
  tibble(predictions_ul_o2) %>% 
    inner_join(tibble(task_ul_o2$row_names), by="row_id") %>% 
    inner_join(dataset_ul, by=c("row_name"="row_id_original")),
  tibble(predictions_ul_tmobile) %>% 
    inner_join(tibble(task_ul_tmobile$row_names), by="row_id") %>% 
    inner_join(dataset_ul, by=c("row_name"="row_id_original")),
  tibble(predictions_ul_vodafone) %>% 
    inner_join(tibble(task_ul_vodafone$row_names), by="row_id") %>% 
    inner_join(dataset_ul, by=c("row_name"="row_id_original"))
)
glimpse(validation_results_ul)
```

```{r}
all(validation_results_ul$truth == validation_results_ul$throughput_mbits)
```

### Scatter Plots

```{r}
ggplot(filter(validation_results_ul, provider=="o2"), aes(x=truth, y=response)) +
  geom_point(aes(color=scenario, shape=scenario)) +
  ggtitle("Predictions for Provider O2")
```

```{r}
ggplot(filter(validation_results_ul, provider=="tmobile"), aes(x=truth, y=response)) +
  geom_point(aes(color=scenario, shape=scenario)) +
  ggtitle("Predictions for Provider T-Mobile")
```

```{r}
ggplot(filter(validation_results_ul, provider=="vodafone"), aes(x=truth, y=response)) +
  geom_point(aes(color=scenario, shape=scenario)) +
  ggtitle("Predictions for Provider Vodafone")
```
