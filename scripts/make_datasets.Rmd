---
title: "Make Datasets"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(tidyverse)
library(lubridate)
library(anytime)
library(matlab)
library(readr)
library(stringr)

```

Define where to get the data from and where to put the resulting data sets:
```{r}
data_source_dir = "../data_raw/"
data_destination_dir = "../datasets/"
```

Define helper functions that get information from a filename:
```{r}
get_provider_by_filename = function(filename) {
  split_result = str_split(filename, "_")
  return(split_result[[1]][2])
}

# example:
get_provider_by_filename("1544519617_vodafone_ul.txt")
```

```{r}
get_datatype_by_filename = function(filename) {
  split_result = str_split(filename, "_")
  ending = split_result[[1]][3]
  split_result_ending = str_split(ending, "\\.")
  return(split_result_ending[[1]][1])
}

# example:
get_datatype_by_filename("1544519617_vodafone_ul.txt")
```

This function creates a dataset for a given `datatype` like "ul", "dl", "context" or cells.
The provider is added as an extra column as well as the scenario.
```{r}
make_dataset = function(data_location, datatype) {
  
  # read all datasets and store them in a list to combine them later
  datasets = list()
  
  scenarios = c("urban", "suburban", "campus", "highway")
  for (cur_scenario in scenarios) {
    
    # get the current path where the files are located and list the files
    cur_path = str_c(data_location, "/", cur_scenario)
    data_files = list.files(cur_path)
    
    # now read each file
    for (cur_filename in data_files) {
      
      # only read when the datatype matches the one we want
      cur_datatype = get_datatype_by_filename(cur_filename)
      if (cur_datatype != datatype) {
        next
      }
      
      # read the file and add a column for the provider and for the scenario
      cur_provider = get_provider_by_filename(cur_filename)
      cur_dataset = read_csv(str_c(cur_path, "/", cur_filename), col_type=cols()) %>%
        mutate(scenario=cur_scenario, provider=cur_provider)
      
      # attach it to the list
      datasets[[length(datasets)+1]] = cur_dataset
    }
  }
  
  # build the final dataset, convert the seconds to proper dates and sort by time
  final_dataset = bind_rows(datasets) %>% 
    mutate(timestamp=as_datetime(timestamp_ms)) %>% 
    arrange(timestamp)
  return(final_dataset)
}
```

Now create the data sets:
```{r}
dataset_ul = make_dataset(data_source_dir, datatype="ul")
glimpse(dataset_ul)
```

```{r}
dataset_dl = make_dataset(data_source_dir, datatype="dl")
glimpse(dataset_dl)
```

```{r}
dataset_context = make_dataset(data_source_dir, datatype="context")
glimpse(dataset_context)
```

```{r}
dataset_cells = make_dataset(data_source_dir, datatype="cells")
glimpse(dataset_cells)
```

# Add the eNodeB-ID

This function converts a cell-ID to an eNodeB-ID:
```{r}
cell_id_to_enodeb = function(cell_id) {
  result = tryCatch(
    {
      hex_string = as.character(as.hexmode(cell_id))
      enodeb_hex = str_sub(hex_string, start=1, end=-3)
      enodeb_integer = as.integer(as.hexmode(enodeb_hex))
      return(enodeb_integer)
    },
    error = function(err) {
      return(NA)
    }
  )
  return(result)
}
```

Let's test it using the example from the slides (the correct eNodeB-ID is 50464):
```{r}
cell_id_to_enodeb(12918809)
```

A few more tests:
```{r}
print(cell_id_to_enodeb(13828122)==54016)
print(cell_id_to_enodeb(26385408)==103068)
print(cell_id_to_enodeb(13067274)==51044)
print(is.na(cell_id_to_enodeb(NA)))
print(is.na(cell_id_to_enodeb(0)))
```

Now update the datasets to also contain the eNodeB-ID:
```{r}
dataset_ul = dataset_ul %>% mutate(enodeb=map_int(ci, cell_id_to_enodeb))
dataset_dl = dataset_dl %>% mutate(enodeb=map_int(ci, cell_id_to_enodeb))
dataset_context = dataset_context %>% mutate(enodeb=map_int(ci, cell_id_to_enodeb))
dataset_cells = dataset_cells %>% mutate(enodeb=map_int(ci, cell_id_to_enodeb))
```

# Add an ID for each drive

```{r}
# this function assumes that the data is sorted by timestamp in ascending order
get_drive_ids = function(data, max_time_delta = minutes(10)) {
  
  num_rows = nrow(data)
  drive_ids = integer(num_rows)
  
  last_timestamp = as_datetime(origin) # the earliest possible date
  cur_drive_id = 0
  
  for(cur_row in seq_len(num_rows)) {
    
    cur_timestamp = data[[cur_row, "timestamp"]]
    
    if (cur_timestamp - last_timestamp > max_time_delta) {
      cur_drive_id = cur_drive_id + 1
    }
    last_timestamp = cur_timestamp
    
    drive_ids[cur_row] = cur_drive_id
  }
  
  return(drive_ids)
}
```

```{r}
dataset_ul = add_column(dataset_ul, drive_id = factor(get_drive_ids(dataset_ul)))
dataset_dl = add_column(dataset_dl, drive_id = factor(get_drive_ids(dataset_dl)))
dataset_context = add_column(dataset_context, drive_id = factor(get_drive_ids(dataset_context)))
dataset_cells = add_column(dataset_cells, drive_id = factor(get_drive_ids(dataset_cells)))
```

```{r}
ggplot(dataset_ul, aes(x=timestamp, y=throughput_mbits)) +
  geom_line(aes(color=drive_id)) +
  geom_point(aes(color=drive_id))
```

Store them:
```{r}
write_csv(dataset_ul, str_c(data_destination_dir, "dataset_ul.csv"))
write_csv(dataset_dl, str_c(data_destination_dir, "dataset_dl.csv"))
write_csv(dataset_context, str_c(data_destination_dir, "dataset_context.csv"))
write_csv(dataset_cells, str_c(data_destination_dir, "dataset_cells.csv"))
```

# Ad dwell time in eNodeB

data

```{r}

setwd("~/GitHub/fallstudien_2_projekt_1/datasets")
data_destination_dir <- "~/GitHub/fallstudien_2_projekt_1/datasets/"

dataset_context <- read.csv("dataset_context.csv", header = TRUE, sep = ",")
#data_cells <- read.csv("dataset_cells.csv", header = TRUE, sep = ",")

dataset_context <- dataset_context[complete.cases(dataset_context),]

dataset_context$dwell_time <- ones(dim(dataset_context)[1], 1)

```


calculate dwell time for provider

```{r}

for (p in c("o2", "tmobile", "vodafone")){
  data_context_p <- dataset_context[which(dataset_context$provider == p),]
  data_context_p$dwell_time <- ones(dim(data_context_p)[1], 1)
  for (j in 1:(dim(data_context_p)[1]-1)){
    enodeb <- data_context_p$enodeb[j]
    for (i in j+1:dim(data_context_p)[1]){
      if (data_context_p$drive_id[i] != data_context_p$drive_id[i-1] |
          data_context_p$enodeb[i] != enodeb){
        data_context_p$dwell_time[j] <- difftime(anytime(data_context_p$timestamp[i-1]),
          anytime(data_context_p$timestamp[j]), units = "secs")
        break
      }
      else if (i == dim(data_context_p)[1]){
        data_context_p$dwell_time[j] <- difftime(anytime(data_context_p$timestamp[i]),
          anytime(data_context_p$timestamp[j]), units = "secs")
        break
      }
    }
  }
  data_context_p$dwell_time[dim(data_context_p)[1]] <- difftime(
    anytime(data_context_p$timestamp[dim(data_context_p)[1]]),
    anytime(data_context_p$timestamp[dim(data_context_p)[1]]), units = "secs")
  
  dataset_context[dataset_context$provider == p,] <- data_context_p
}


```


```{r}

head(dataset_context)

```

```{r}

write_csv(dataset_context, str_c(data_destination_dir, "dataset_context.csv"))


```